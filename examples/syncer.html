<html>
    <head>
        <title>Syncer example</title>

        <style>
            body,
            html {
                margin: 0;
                background: gray;
            }
        </style>
    </head>

    <body>
        <div id="viewport"></div>

        <script src="../node_modules/three/build/three.min.js"></script>
        <script src="../dist/tetsuo.min.js"></script>

        <script>
            let syncer, renderer, time, untilBPMNode;

            // when page is ready
            TETSUO.Utils.ready(() => {
                // initialize preloader
                let preloader = new TETSUO.Preloader();

                // load all files declared in the manifest
                preloader.loadManifest("res/manifest.json", (assets) => {
                    // create a syncer using the loaded music
                    syncer = new TETSUO.Syncer(assets["music"], {
                        bpm: 73,
                    });

                    // create a start button to start the music
                    TETSUO.Utils.createStartButton(start);
                });
            });

            function start() {
                renderer = new TETSUO.NodeRenderer();

                // create a uniform node to pass the time until next beat to shader
                untilBPMNode = new TETSUO.UniformNode({ value: 0 });

                // create a shader node that pulsates with BPM
                let node = new TETSUO.ShaderNode({
                    fragmentShader: /* glsl */ `
                        uniform float untilBPM;

                        void main() {
                            gl_FragColor = vec4(untilBPM / 1000.);
                        }    
                    `,
                }).addInput(untilBPMNode, "untilBPM");

                renderer.connectToScreen(node);

                // start syncer
                syncer.play();

                // start update
                tick();
            }

            function tick() {
                time = performance.now() / 1000;

                // update and render
                renderer.update(time);
                renderer.render();

                // update syncer
                syncer.update();

                // update time until beat uniform
                untilBPMNode.setValue(syncer.getUntilBPM());

                requestAnimationFrame(tick);
            }
        </script>
    </body>
</html>
